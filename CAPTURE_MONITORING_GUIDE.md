# üìä Guia de Monitoramento de Captura de Pacotes

## üéØ Vis√£o Geral

O sistema de monitoramento de captura de pacotes foi implementado para fornecer **visibilidade completa** sobre o que est√° sendo interceptado pelo servi√ßo de Capture. Ele inclui logging estruturado, m√©tricas em tempo real e alertas autom√°ticos.

---

## üèóÔ∏è Componentes do Sistema

### 1. **PacketCaptureMetrics** üìà
Modelo que armazena todas as m√©tricas de captura:
- Total de pacotes capturados
- Pacotes v√°lidos vs descartados
- Taxa de pacotes/bytes por segundo
- Tempo de atividade
- Contadores de erro
- Status da captura

### 2. **PacketCaptureMonitor** üîç
Servi√ßo de monitoramento que:
- Registra eventos de captura
- Calcula m√©tricas em tempo real
- Gera alertas autom√°ticos
- Fornece logging estruturado
- Atualiza estat√≠sticas periodicamente

### 3. **PacketCaptureService** (Atualizado) üöÄ
Integra√ß√£o completa com monitoramento:
- Logging de dispositivos de rede
- Registro de pacotes capturados
- Tratamento de erros com contexto
- M√©tricas de performance

---

## üöÄ Como Usar

### **Inicializa√ß√£o B√°sica**

```csharp
// Criar logger
var loggerFactory = LoggerFactory.Create(builder => 
    builder.AddConsole().SetMinimumLevel(LogLevel.Debug));
var logger = loggerFactory.CreateLogger<PacketCaptureService>();

// Inicializar servi√ßo com monitoramento
var captureService = new PacketCaptureService(5050, logger);

// Acessar monitor
var monitor = captureService.Monitor;

// Configurar eventos de m√©tricas
monitor.OnMetricsUpdated += metrics => 
{
    Console.WriteLine($"üìä {metrics}");
};
```

### **Iniciando Captura com Monitoramento**

```csharp
try
{
    // Iniciar captura (logs autom√°ticos inclu√≠dos)
    captureService.Start();
    
    // O monitor registrar√° automaticamente:
    // - Dispositivos de rede encontrados
    // - Filtros aplicados
    // - In√≠cio da captura
    // - Pacotes capturados em tempo real
}
catch (Exception ex)
{
    // Erros s√£o automaticamente registrados no monitor
    Console.WriteLine($"Erro: {ex.Message}");
}
```

### **Monitoramento em Tempo Real**

```csharp
// Atualizar m√©tricas manualmente
captureService.UpdateMetrics();

// Obter resumo detalhado
captureService.LogDetailedMetrics();

// Acessar m√©tricas diretamente
var metrics = monitor.Metrics;
Console.WriteLine($"Pacotes capturados: {metrics.ValidPacketsCaptured}");
Console.WriteLine($"Taxa: {metrics.PacketsPerSecond:F2} pkt/s");
Console.WriteLine($"Status: {metrics.Status}");
```

---

## üìã Tipos de Logs Gerados

### **1. Logs de Inicializa√ß√£o**
```
2025-01-29 15:30:00.123 [INF] PacketCaptureService inicializado - Porta: 5050, Filtro: udp and port 5050
2025-01-29 15:30:00.125 [INF] Verificando drivers de captura de pacotes...
2025-01-29 15:30:00.127 [INF] Sistema operacional: Linux
2025-01-29 15:30:00.130 [INF] Dispositivos de rede dispon√≠veis: 3
```

### **2. Logs de Dispositivos**
```
2025-01-29 15:30:00.135 [DBG] Dispositivo 0: Ethernet (eth0)
2025-01-29 15:30:00.137 [DBG] Dispositivo 1: Loopback (lo)
2025-01-29 15:30:00.139 [DBG] Dispositivo 2: Wi-Fi (wlan0)
2025-01-29 15:30:00.141 [DBG] Dispositivo v√°lido (MAC): Ethernet
```

### **3. Logs de Captura**
```
2025-01-29 15:30:00.150 [INF] Iniciando captura em 2 dispositivos v√°lidos
2025-01-29 15:30:00.155 [INF] Captura iniciada - Interface: Ethernet, Filtro: udp and port 5050
2025-01-29 15:30:00.160 [INF] Filtro aplicado - Dispositivo: Ethernet, Filtro: udp and port 5050
```

### **4. Logs de Pacotes** (Debug/Trace)
```
2025-01-29 15:30:01.200 [DBG] Pacote capturado - Tamanho: 256 bytes, Total: 1
2025-01-29 15:30:01.201 [DBG] Pacote UDP capturado - Origem: 192.168.1.100:5050, Destino: 192.168.1.200:5050, Tamanho: 256 bytes
2025-01-29 15:30:01.202 [TRC] Pacote hex preview: F001010001000000000203...
```

### **5. Logs de Estat√≠sticas** (Peri√≥dicos)
```
2025-01-29 15:30:05.000 [INF] Estat√≠sticas de captura: Status: Running | Packets: 45/47 | Rate: 9.00 pkt/s, 2304.00 B/s | Dropped: 2 | Errors: 0 | Uptime: 00:00:05
```

### **6. Logs de Alertas**
```
2025-01-29 15:30:35.000 [WRN] Taxa de captura baixa - Nenhum pacote capturado nos √∫ltimos 30 segundos
2025-01-29 15:31:00.000 [WRN] Taxa de captura muito baixa: 0.05 pacotes/segundo
```

### **7. Logs de Erro**
```
2025-01-29 15:30:00.500 [ERR] Erro na captura de pacotes - Contexto: Device_OnPacketArrival, Total de erros: 1
System.ArgumentException: Invalid packet format
   at PacketDotNet.Packet.ParsePacket(...)
```

---

## ‚öôÔ∏è Configura√ß√£o de Logging

### **appsettings.json**
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "AlbionOnlineSniffer.Capture": "Debug",
      "AlbionOnlineSniffer.Capture.Services.PacketCaptureMonitor": "Information"
    },
    "Console": {
      "IncludeScopes": true,
      "TimestampFormat": "yyyy-MM-dd HH:mm:ss.fff "
    }
  },
  "PacketMonitoring": {
    "EnableDetailedLogging": true,
    "EnableHexDump": false,
    "MetricsUpdateInterval": 5,
    "LogPeriodicStats": true,
    "AlertOnLowCaptureRate": true,
    "LowCaptureRateThreshold": 0.1
  }
}
```

### **N√≠veis de Log Recomendados**

| Cen√°rio | N√≠vel | Descri√ß√£o |
|---------|-------|-----------|
| **Produ√ß√£o** | `Information` | Logs essenciais, estat√≠sticas, alertas |
| **Debug** | `Debug` | + Detalhes de pacotes, dispositivos |
| **Desenvolvimento** | `Trace` | + Hex dumps, logs detalhados |

---

## üìä M√©tricas Dispon√≠veis

### **M√©tricas B√°sicas**
- `TotalPacketsCaptured`: Total de pacotes interceptados
- `ValidPacketsCaptured`: Pacotes UDP v√°lidos na porta correta
- `PacketsDropped`: Pacotes descartados (inv√°lidos)
- `TotalBytesCapturated`: Total de bytes processados

### **M√©tricas de Performance**
- `PacketsPerSecond`: Taxa de pacotes por segundo
- `BytesPerSecond`: Taxa de bytes por segundo
- `TotalCaptureTime`: Tempo total de captura ativa

### **M√©tricas de Qualidade**
- `CaptureErrors`: N√∫mero de erros de captura
- `LastError`: √öltima mensagem de erro
- `LastErrorTime`: Timestamp do √∫ltimo erro
- `Status`: Status atual ("Running", "Stopped", etc.)

### **Informa√ß√µes de Contexto**
- `LastInterface`: √öltima interface de rede utilizada
- `LastFilter`: √öltimo filtro aplicado
- `LastCaptureTime`: Timestamp da √∫ltima captura

---

## üîß API de Monitoramento

### **M√©todos Dispon√≠veis**

```csharp
// For√ßar atualiza√ß√£o de m√©tricas
captureService.UpdateMetrics();

// Log detalhado das m√©tricas
captureService.LogDetailedMetrics();

// Acessar m√©tricas diretamente
var metrics = captureService.Monitor.Metrics;

// Configurar eventos
captureService.Monitor.OnMetricsUpdated += OnMetricsChanged;

// Logs manuais
captureService.Monitor.LogCaptureError(exception, "contexto");
captureService.Monitor.LogPeriodicStats();
```

### **Eventos Dispon√≠veis**

```csharp
// Evento de atualiza√ß√£o de m√©tricas (a cada 5 segundos)
monitor.OnMetricsUpdated += (metrics) => 
{
    // Processar m√©tricas atualizadas
    UpdateUI(metrics);
    CheckAlerts(metrics);
};
```

---

## üö® Sistema de Alertas

### **Alertas Autom√°ticos**

1. **Taxa de Captura Baixa**
   - Dispara se n√£o houver pacotes por 30+ segundos
   - √ötil para detectar problemas de rede

2. **Taxa Muito Baixa**
   - Dispara se < 0.1 pacotes/segundo ap√≥s 1 minuto
   - Indica poss√≠vel problema de configura√ß√£o

3. **Erros de Captura**
   - Log imediato de qualquer erro
   - Inclui contexto e stack trace

### **Alertas Customizados**

```csharp
monitor.OnMetricsUpdated += (metrics) => 
{
    // Alerta personalizado: alta taxa de descarte
    if (metrics.PacketsDropped > metrics.ValidPacketsCaptured * 0.1)
    {
        logger.LogWarning("Alta taxa de descarte: {DropRate:P}", 
            (double)metrics.PacketsDropped / metrics.TotalPacketsCaptured);
    }
    
    // Alerta personalizado: uso de mem√≥ria
    if (metrics.TotalBytesCapturated > 100_000_000) // 100MB
    {
        logger.LogWarning("Alto uso de dados: {DataSize:N0} bytes capturados", 
            metrics.TotalBytesCapturated);
    }
};
```

---

## üìà Exemplo de Sa√≠da Completa

```
2025-01-29 15:30:00.123 [INF] PacketCaptureService inicializado - Porta: 5050
2025-01-29 15:30:00.125 [INF] PacketCaptureMonitor inicializado
2025-01-29 15:30:00.130 [INF] Dispositivos de rede encontrados: 3
2025-01-29 15:30:00.135 [INF] Iniciando captura em 2 dispositivos v√°lidos
2025-01-29 15:30:00.140 [INF] Captura iniciada - Interface: eth0, Filtro: udp and port 5050
2025-01-29 15:30:01.200 [DBG] Pacote capturado - Tamanho: 256 bytes, Total: 1
2025-01-29 15:30:01.250 [DBG] Pacote capturado - Tamanho: 128 bytes, Total: 2
2025-01-29 15:30:05.000 [INF] Estat√≠sticas de captura: Status: Running | Packets: 45/47 | Rate: 9.00 pkt/s, 2304.00 B/s | Dropped: 2 | Errors: 0 | Uptime: 00:00:05
2025-01-29 15:30:10.000 [INF] Estat√≠sticas de captura: Status: Running | Packets: 89/92 | Rate: 8.90 pkt/s, 2276.80 B/s | Dropped: 3 | Errors: 0 | Uptime: 00:00:10

=== RESUMO DETALHADO DE CAPTURA ===
Status: Running
Interface: eth0
Filtro: udp and port 5050
Tempo ativo: 00:01:00
Pacotes totais: 540
Pacotes v√°lidos: 535
Pacotes descartados: 5
Bytes capturados: 137,280
Taxa de pacotes: 8.92 pkt/s
Taxa de bytes: 2,288.00 B/s
Erros de captura: 0
=== FIM DO RESUMO ===
```

---

## üéØ Benef√≠cios do Sistema

### **1. Visibilidade Completa** üëÅÔ∏è
- Monitoramento em tempo real de tudo que √© capturado
- M√©tricas detalhadas de performance
- Hist√≥rico de erros e problemas

### **2. Debugging Facilitado** üêõ
- Logs estruturados com contexto
- Hex dumps opcionais para an√°lise profunda
- Rastreamento de dispositivos e filtros

### **3. Alertas Proativos** üö®
- Detec√ß√£o autom√°tica de problemas
- Alertas configur√°veis
- Monitoramento de sa√∫de do sistema

### **4. Performance Otimizada** ‚ö°
- Logging ass√≠ncrono para n√£o impactar captura
- M√©tricas calculadas em background
- Configura√ß√£o flex√≠vel de n√≠veis de log

### **5. Integra√ß√£o F√°cil** üîß
- API simples e intuitiva
- Configura√ß√£o via appsettings.json
- Compat√≠vel com sistema de logging existente

---

## üìù Resumo de Uso

```csharp
// 1. Inicializar com logging
var captureService = new PacketCaptureService(5050, logger);

// 2. Configurar monitoramento
captureService.Monitor.OnMetricsUpdated += metrics => 
    Console.WriteLine($"üìä {metrics}");

// 3. Iniciar captura (logs autom√°ticos)
captureService.Start();

// 4. Monitorar em tempo real
captureService.UpdateMetrics();
captureService.LogDetailedMetrics();

// 5. Finalizar (logs de resumo autom√°ticos)
captureService.Dispose();
```

O sistema agora fornece **visibilidade completa** sobre a intercepta√ß√£o de pacotes, facilitando debugging, monitoramento e otimiza√ß√£o do processo de captura! üéâ